<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="description" content="Sistema de gerenciamento de pedidos da Galinhada da R√¥">
  <meta name="theme-color" content="#ff6b35">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Cantina da R√¥">
  
  <title>Dashboard - Galinhada da R√¥</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- √çcones Apple -->
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="icon-192.png">

  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap');

    :root{
      --bg:#0a0908;
      --panel:#1a1816;
      --text:#f5f3f0;
      --muted:#b8a89a;
      --accent:#ff6b35;
      --accent2:#f77f00;
      --dark:#3d2a23;
      --ok:#4ade80;
      --pending:#fbbf24;
      --danger:#ef4444;
    }

    *{ 
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body{
      margin:0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1a1816 0%, #0a0908 100%);
      color:var(--text);
      min-height:100vh;
      padding-bottom:20px;
    }

    /* NAVBAR */
    .navbar{
      background: rgba(26,24,22,.98);
      backdrop-filter: blur(10px);
      border-bottom:2px solid rgba(255,107,53,.3);
      padding:12px 16px;
      position:sticky;
      top:0;
      z-index:100;
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }

    .navbar-brand{
      text-align:center;
      font-size:22px;
      font-weight:900;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom:12px;
    }

    .navbar-menu{
      display:flex;
      gap:8px;
      justify-content:center;
    }

    .nav-btn{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:2px solid transparent;
      background:rgba(255,107,53,.1);
      color:var(--muted);
      font-weight:600;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      transition: all .3s;
      font-family: 'Poppins', sans-serif;
      font-size:11px;
      max-width:110px;
    }

    .nav-btn svg{
      width:20px;
      height:20px;
    }

    .nav-btn:active{
      transform: scale(0.95);
    }

    .nav-btn.active{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
    }

    /* CONTAINER */
    .container{
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }

    @media (min-width: 768px){
      .container{
        padding:24px;
      }
    }

    /* HEADER */
    .header{
      text-align:center;
      margin-bottom:20px;
      padding:20px 16px;
      background: linear-gradient(135deg, rgba(255,107,53,.15), rgba(247,127,0,.1));
      border-radius:16px;
      border:2px solid rgba(255,107,53,.3);
    }

    .header h1{
      font-size:24px;
      font-weight:900;
      margin:0 0 6px 0;
      color:var(--text);
    }

    .header p{
      font-size:13px;
      color:var(--muted);
      margin:0;
    }

    /* STATS */
    .stats-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
      margin-bottom:20px;
    }

    @media (min-width: 768px){
      .stats-grid{
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .stat-card{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:16px;
      text-align:center;
    }

    .stat-icon{
      width:48px;
      height:48px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto 12px auto;
    }

    .stat-icon.orange{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }

    .stat-icon.green{
      background: linear-gradient(135deg, #4ade80, #22c55e);
    }

    .stat-icon.yellow{
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }

    .stat-icon svg{
      width:24px;
      height:24px;
      color:#fff;
    }

    .stat-label{
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
      margin:0 0 6px 0;
    }

    .stat-value{
      font-size:24px;
      font-weight:900;
      color:var(--text);
      margin:0;
    }

    /* FILTERS */
    .filters{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:16px;
      margin-bottom:16px;
    }

    .filter-group{
      margin-bottom:12px;
    }

    .filter-group:last-child{
      margin-bottom:0;
    }

    .filter-group label{
      display:block;
      font-size:12px;
      font-weight:700;
      color:var(--muted);
      margin:0 0 8px 2px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .filter-input{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:2px solid rgba(255,107,53,.2);
      background:rgba(0,0,0,.3);
      color:var(--text);
      font-family: 'Poppins', sans-serif;
      font-size:14px;
      outline:none;
    }

    .filter-input:focus{
      border-color:var(--accent);
      background:rgba(0,0,0,.5);
    }

    @media (min-width: 768px){
      .filters{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:16px;
      }
      .filter-group{
        margin-bottom:0;
      }
    }

    /* ORDERS */
    .orders-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }

    .orders-title{
      font-size:18px;
      font-weight:700;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
    }

    .refresh-btn{
      padding:10px 16px;
      border-radius:10px;
      border:2px solid var(--accent);
      background:rgba(255,107,53,.1);
      color:var(--accent);
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      font-family: 'Poppins', sans-serif;
      font-size:13px;
    }

    .refresh-btn:active{
      transform: scale(0.95);
    }

    /* ORDER CARD */
    .order-card{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:16px;
      margin-bottom:12px;
    }

    .order-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(255,107,53,.2);
    }

    .order-client{
      flex:1;
    }

    .order-name{
      font-size:16px;
      font-weight:700;
      color:var(--text);
      margin:0 0 4px 0;
    }

    .order-date{
      font-size:11px;
      color:var(--muted);
      margin:0;
    }

    .status-badge{
      padding:6px 12px;
      border-radius:20px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .status-badge.pending{
      background:rgba(251,191,36,.2);
      color:#fbbf24;
      border:1px solid #fbbf24;
    }

    .status-badge.delivered{
      background:rgba(74,222,128,.2);
      color:#4ade80;
      border:1px solid #4ade80;
    }

    .status-badge.cancelled{
      background:rgba(239,68,68,.2);
      color:#ef4444;
      border:1px solid #ef4444;
    }

    .order-info{
      display:grid;
      gap:8px;
      margin-bottom:12px;
    }

    .order-row{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
    }

    .order-row svg{
      width:16px;
      height:16px;
      color:var(--accent);
      flex-shrink:0;
    }

    .order-row strong{
      color:var(--muted);
      min-width:70px;
    }

    .order-row span{
      color:var(--text);
      font-weight:600;
    }

    .order-token{
      background:rgba(255,107,53,.1);
      padding:10px;
      border-radius:8px;
      text-align:center;
      margin-bottom:12px;
      border:1px solid rgba(255,107,53,.3);
    }

    .order-token-label{
      font-size:10px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      margin:0 0 4px 0;
    }

    .order-token-value{
      font-size:18px;
      font-weight:900;
      color:var(--accent);
      font-family: 'Courier New', monospace;
      letter-spacing:2px;
      margin:0;
    }

    .order-actions{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:8px;
    }

    .order-actions.full{
      grid-template-columns: 1fr;
    }

    .action-btn{
      padding:10px;
      border-radius:8px;
      border:none;
      font-weight:600;
      cursor:pointer;
      font-family: 'Poppins', sans-serif;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    .action-btn:active{
      transform: scale(0.95);
    }

    .action-btn.primary{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
    }

    .action-btn.danger{
      background:rgba(239,68,68,.2);
      color:#ef4444;
      border:1px solid #ef4444;
    }

    .action-btn.success{
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color:#fff;
    }

    .action-btn.secondary{
      background:rgba(255,107,53,.1);
      color:var(--accent);
      border:1px solid var(--accent);
    }

    /* MODAL */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      backdrop-filter:blur(4px);
      z-index:1000;
      padding:20px;
      overflow-y:auto;
    }

    .modal.active{
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .modal-content{
      background: linear-gradient(135deg, rgba(61,42,35,.95), rgba(26,24,22,.95));
      border:2px solid rgba(255,107,53,.3);
      border-radius:20px;
      padding:24px;
      max-width:500px;
      width:100%;
    }

    .modal-header{
      margin-bottom:20px;
      text-align:center;
    }

    .modal-header h2{
      font-size:20px;
      font-weight:900;
      margin:0 0 6px 0;
    }

    .modal-header p{
      font-size:13px;
      color:var(--muted);
      margin:0;
    }

    .modal-body{
      margin-bottom:20px;
    }

    .info-item{
      padding:12px;
      background:rgba(255,107,53,.05);
      border-radius:10px;
      border:1px solid rgba(255,107,53,.2);
      margin-bottom:10px;
    }

    .info-item label{
      font-size:11px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
      display:block;
      margin-bottom:4px;
    }

    .info-item p{
      font-size:15px;
      font-weight:700;
      color:var(--text);
      margin:0;
    }

    .token-input{
      width:100%;
      padding:14px;
      border-radius:10px;
      border:2px solid var(--accent);
      background:rgba(0,0,0,.3);
      color:var(--text);
      font-family: 'Courier New', monospace;
      font-size:18px;
      font-weight:700;
      text-align:center;
      letter-spacing:2px;
      text-transform:uppercase;
      outline:none;
      margin-top:12px;
    }

    .status-select{
      width:100%;
      padding:14px;
      border-radius:10px;
      border:2px solid var(--accent);
      background:rgba(0,0,0,.3);
      color:var(--text);
      font-family: 'Poppins', sans-serif;
      font-size:15px;
      font-weight:600;
      outline:none;
      margin-top:12px;
    }

    .modal-footer{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .modal-btn{
      padding:14px;
      border-radius:10px;
      border:none;
      font-weight:700;
      cursor:pointer;
      font-family: 'Poppins', sans-serif;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .modal-btn:active{
      transform: scale(0.95);
    }

    .modal-btn.cancel{
      background:rgba(255,255,255,.1);
      color:var(--text);
      border:2px solid rgba(255,255,255,.2);
    }

    .modal-btn.confirm{
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color:#fff;
    }

    .modal-btn.danger{
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color:#fff;
    }

    .loading-state,
    .empty-state{
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
    }

    .loading-state svg,
    .empty-state svg{
      width:48px;
      height:48px;
      margin-bottom:16px;
      opacity:.5;
    }

    .loading-state svg{
      animation: spin 1s linear infinite;
    }

    @keyframes spin{
      from{ transform:rotate(0deg); }
      to{ transform:rotate(360deg); }
    }

    /* BOT√ÉO FLUTUANTE VALIDADOR */
    .fab-validador{
      position:fixed;
      bottom:24px;
      right:24px;
      width:64px;
      height:64px;
      border-radius:50%;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color:#fff;
      border:none;
      box-shadow: 0 8px 24px rgba(74,222,128,.4);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: all .3s;
      z-index:1000;
      text-decoration:none;
    }

    .fab-validador:hover{
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 12px 32px rgba(74,222,128,.6);
    }

    .fab-validador:active{
      transform: scale(0.95);
    }

    .fab-validador svg{
      width:32px;
      height:32px;
    }

    @media (max-width: 768px){
      .fab-validador{
        bottom:20px;
        right:20px;
        width:56px;
        height:56px;
      }
      .fab-validador svg{
        width:28px;
        height:28px;
      }
    }

    /* NOTIFICA√á√ïES TOAST */
    .toast{
      position:fixed;
      bottom:30px;
      right:30px;
      min-width:300px;
      max-width:400px;
      background:rgba(26,24,22,.95);
      backdrop-filter:blur(10px);
      border-radius:12px;
      padding:16px 20px;
      box-shadow:0 8px 32px rgba(0,0,0,.4);
      border:2px solid rgba(255,107,53,.3);
      display:flex;
      align-items:center;
      gap:12px;
      z-index:10000;
      animation:slideInRight .3s ease;
      pointer-events:auto;
    }

    .toast.success{
      border-color:#4ade80;
    }

    .toast.error{
      border-color:#ef4444;
    }

    .toast-icon{
      width:24px;
      height:24px;
      flex-shrink:0;
    }

    .toast.success .toast-icon{
      color:#4ade80;
    }

    .toast.error .toast-icon{
      color:#ef4444;
    }

    .toast-message{
      flex:1;
      font-size:14px;
      font-weight:600;
      color:var(--text);
    }

    .toast-close{
      width:20px;
      height:20px;
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s;
    }

    .toast-close:hover{
      color:var(--text);
    }

    @keyframes slideInRight{
      from{
        transform:translateX(400px);
        opacity:0;
      }
      to{
        transform:translateX(0);
        opacity:1;
      }
    }

    @keyframes slideOutRight{
      from{
        transform:translateX(0);
        opacity:1;
      }
      to{
        transform:translateX(400px);
        opacity:0;
      }
    }

    .toast.hiding{
      animation:slideOutRight .3s ease forwards;
    }

    @media (max-width: 768px){
      .toast{
        bottom:20px;
        right:20px;
        left:20px;
        min-width:auto;
      }
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="navbar-brand">
      <i data-lucide="utensils" style="width:20px;height:20px;"></i>
      Galinhada da R√¥
    </div>
    <div class="navbar-menu">
      <button class="nav-btn active">
        <i data-lucide="layout-dashboard"></i>
        <span>Dashboard</span>
      </button>
      <button class="nav-btn" onclick="window.location.href='novo-pedido-mobile.html'">
        <i data-lucide="plus-circle"></i>
        <span>Novo Pedido</span>
      </button>
      <button class="nav-btn" onclick="window.location.href='relatorios-mobile.html'">
        <i data-lucide="bar-chart-3"></i>
        <span>Relat√≥rios</span>
      </button>
    </div>
  </nav>

  <!-- CONTAINER -->
  <div class="container">
    
    <!-- HEADER -->
    <div class="header">
      <h1><i data-lucide="layout-dashboard" style="width:28px;height:28px;vertical-align:middle;"></i> Dashboard</h1>
      <p>Gerencie suas entregas</p>
    </div>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon orange">
          <i data-lucide="shopping-bag"></i>
        </div>
        <p class="stat-label">Total</p>
        <p class="stat-value" id="statTotal">0</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon yellow">
          <i data-lucide="clock"></i>
        </div>
        <p class="stat-label">Pendentes</p>
        <p class="stat-value" id="statPending">0</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon green">
          <i data-lucide="check-circle"></i>
        </div>
        <p class="stat-label">Entregues</p>
        <p class="stat-value" id="statDelivered">0</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon orange">
          <i data-lucide="dollar-sign"></i>
        </div>
        <p class="stat-label">Vendido</p>
        <p class="stat-value" id="statRevenue">R$ 0</p>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="filters">
      <div class="filter-group">
        <label>Buscar por nome</label>
        <input type="text" class="filter-input" id="filterName" placeholder="Digite o nome...">
      </div>

      <div class="filter-group">
        <label>Status</label>
        <select class="filter-input" id="filterStatus">
          <option value="">Todos</option>
          <option value="pendente">Pendentes</option>
          <option value="entregue">Entregues</option>
          <option value="cancelado">Cancelados</option>
        </select>
      </div>
    </div>

    <!-- ORDERS HEADER -->
    <div class="orders-header">
      <h2 class="orders-title">
        <i data-lucide="list"></i>
        Pedidos
      </h2>
      <button class="refresh-btn" onclick="loadOrders()">
        <i data-lucide="refresh-cw"></i>
        Atualizar
      </button>
    </div>

    <!-- LOADING -->
    <div id="loadingState" class="loading-state">
      <i data-lucide="loader"></i>
      <p>Carregando pedidos...</p>
    </div>

    <!-- EMPTY -->
    <div id="emptyState" class="empty-state" style="display:none;">
      <i data-lucide="inbox"></i>
      <h3>Nenhum pedido encontrado</h3>
      <p>Crie seu primeiro pedido para come√ßar</p>
    </div>

    <!-- ORDERS LIST -->
    <div id="ordersList"></div>

  </div>

  <!-- MODAL VALIDAR -->
  <div class="modal" id="validateModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîë Validar Entrega</h2>
        <p>Digite o token do cliente</p>
      </div>

      <div class="modal-body">
        <div class="info-item">
          <label>Cliente</label>
          <p id="modalClientName">‚Äî</p>
        </div>

        <div class="info-item">
          <label>Token Correto</label>
          <p id="modalCorrectToken" style="color:var(--accent);font-family:'Courier New',monospace;font-size:20px;">‚Äî</p>
        </div>

        <input type="text" class="token-input" id="tokenInput" placeholder="Digite o token" maxlength="7">
      </div>

      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeModal()">
          <i data-lucide="x"></i>
          Cancelar
        </button>
        <button class="modal-btn confirm" onclick="confirmDelivery()">
          <i data-lucide="check"></i>
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL ALTERAR STATUS -->
  <div class="modal" id="changeStatusModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîÑ Alterar Status</h2>
        <p>Escolha o novo status</p>
      </div>

      <div class="modal-body">
        <div class="info-item">
          <label>Cliente</label>
          <p id="modalStatusClientName">‚Äî</p>
        </div>

        <select class="status-select" id="newStatusSelect">
          <option value="pendente">‚è≥ Pendente</option>
          <option value="entregue"><i data-lucide="check-circle" style="width:20px;height:20px;"></i> Entregue</option>
          <option value="cancelado">‚ùå Cancelado</option>
        </select>
      </div>

      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeModal()">
          <i data-lucide="x"></i>
          Cancelar
        </button>
        <button class="modal-btn confirm" onclick="confirmChangeStatus()">
          <i data-lucide="check"></i>
          Alterar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL EXCLUIR -->
  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üóëÔ∏è Excluir Pedido</h2>
        <p>Esta a√ß√£o n√£o pode ser desfeita</p>
      </div>

      <div class="modal-body">
        <div class="info-item">
          <label>Cliente</label>
          <p id="modalDeleteClientName">‚Äî</p>
        </div>

        <p style="color:var(--danger);font-size:13px;text-align:center;margin:16px 0 0 0;">
          ‚ö†Ô∏è Tem certeza que deseja excluir este pedido?
        </p>
      </div>

      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeModal()">
          <i data-lucide="x"></i>
          Cancelar
        </button>
        <button class="modal-btn danger" onclick="confirmDelete()">
          <i data-lucide="trash-2"></i>
          Excluir
        </button>
      </div>
    </div>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWZqrvpUyfTwwl0cnDL9SmnruhVrRRNhzT0sDwsIaRTDdY-77jcwgLne7mESpSUCfy/exec";

    lucide.createIcons();

    let allOrders = [];
    let currentOrder = null;

    // Sistema de notifica√ß√µes Toast
    function showToast(message, type = 'success'){
      // Remover toasts antigos
      document.querySelectorAll('.toast').forEach(t => t.remove());

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = type === 'success' ? 'check-circle' : 'alert-circle';
      
      toast.innerHTML = `
        <i data-lucide="${icon}" class="toast-icon"></i>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i data-lucide="x"></i>
        </button>
      `;
      
      document.body.appendChild(toast);
      lucide.createIcons();
      
      // Auto remover ap√≥s 4 segundos
      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // Carregar pedidos
    async function loadOrders(){
      const loadingEl = document.getElementById('loadingState');
      const emptyEl = document.getElementById('emptyState');
      const listEl = document.getElementById('ordersList');

      loadingEl.style.display = 'block';
      emptyEl.style.display = 'none';
      listEl.innerHTML = '';

      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getOrders`);
        const data = await response.json();
        
        allOrders = data.orders || [];
        
        if(allOrders.length === 0){
          loadingEl.style.display = 'none';
          emptyEl.style.display = 'block';
          updateStats();
        } else {
          loadingEl.style.display = 'none';
          renderOrders();
          updateStats();
        }

      } catch(error){
        console.error('Erro:', error);
        loadingEl.innerHTML = '<p style="color:var(--danger)">‚ùå Erro ao carregar</p>';
      }
    }

    // Renderizar pedidos
    function renderOrders(){
      const listEl = document.getElementById('ordersList');
      const filterName = document.getElementById('filterName').value.toLowerCase();
      const filterStatus = document.getElementById('filterStatus').value;

      let filtered = allOrders.filter(order => {
        const matchName = order.nome.toLowerCase().includes(filterName);
        const matchStatus = !filterStatus || order.status === filterStatus;
        return matchName && matchStatus;
      });

      listEl.innerHTML = '';

      if(filtered.length === 0){
        listEl.innerHTML = '<div class="empty-state"><i data-lucide="inbox"></i><h3>Nenhum pedido encontrado</h3></div>';
        lucide.createIcons();
        return;
      }

      filtered.forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        
        const statusClass = order.status === 'entregue' ? 'delivered' : order.status === 'cancelado' ? 'cancelled' : 'pending';
        const statusText = order.status === 'entregue' ? 'Entregue' : order.status === 'cancelado' ? 'Cancelado' : 'Pendente';
        
        card.innerHTML = `
          <div class="order-header">
            <div class="order-client">
              <p class="order-name">${order.nome}</p>
              <p class="order-date">${order.timestamp}</p>
            </div>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>

          <div class="order-info">
            <div class="order-row">
              <i data-lucide="phone"></i>
              <strong>Contato:</strong>
              <span>${order.contato}</span>
            </div>
            <div class="order-row">
              <i data-lucide="shopping-bag"></i>
              <strong>Quantidade:</strong>
              <span>${order.quantidade} marmita${order.quantidade > 1 ? 's' : ''}</span>
            </div>
            <div class="order-row">
              <i data-lucide="dollar-sign"></i>
              <strong>Valor:</strong>
              <span>${order.valor}</span>
            </div>
            <div class="order-row">
              <i data-lucide="credit-card"></i>
              <strong>Pagamento:</strong>
              <span class="status-badge ${order.pagamento === 'pago' ? 'delivered' : 'pending'}">
                ${order.pagamento === 'pago' ? '‚úÖ Pago' : '‚è≥ Aguardando'}
              </span>
            </div>
          </div>

          <div class="order-token">
            <p class="order-token-label">üîë Token</p>
            <p class="order-token-value">${order.token}</p>
          </div>

          <div class="order-actions" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
            <button class="action-btn" onclick="openEditModal(allOrders.find(o => o.rowIndex === ${order.rowIndex}))" style="background:rgba(59,130,246,.15);color:#3b82f6;border:2px solid #3b82f6;">
              <i data-lucide="edit-3"></i> Editar
            </button>
            ${order.status === 'pendente' ? `
              <button class="action-btn primary" onclick="openValidateModal(${order.rowIndex})">
                <i data-lucide="check"></i> Validar
              </button>
            ` : `
              <button class="action-btn secondary" onclick="openChangeStatusModal(${order.rowIndex})">
                <i data-lucide="sliders"></i> Status
              </button>
            `}
            <button class="action-btn danger" onclick="confirmDelete(${order.rowIndex})" style="grid-column:span 2;">
              <i data-lucide="trash-2"></i> Excluir Pedido
            </button>
          </div>
        `;

        listEl.appendChild(card);
      });

      lucide.createIcons();
    }

    // Atualizar estat√≠sticas
    function updateStats(){
      // Filtrar apenas pedidos N√ÉO cancelados
      const activeOrders = allOrders.filter(o => o.status !== 'cancelado');
      
      const total = activeOrders.length;
      const pending = activeOrders.filter(o => o.status === 'pendente' || !o.status || o.status === '').length;
      const delivered = activeOrders.filter(o => o.status === 'entregue').length;
      
      // Calcular receita apenas de pedidos N√ÉO cancelados
      const revenue = activeOrders.reduce((sum, order) => {
        try {
          const valorStr = (order.valor || 'R$ 0,00').toString();
          const value = parseFloat(valorStr.replace('R$', '').replace('.', '').replace(',', '.').trim());
          return sum + (isNaN(value) ? 0 : value);
        } catch(e) {
          return sum;
        }
      }, 0);

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statDelivered').textContent = delivered;
      document.getElementById('statRevenue').textContent = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(revenue);
    }

    // Modais
    // Excluir pedido direto (sem modal)
    async function confirmDelete(rowIndex){
      const order = allOrders.find(o => o.rowIndex === rowIndex);
      if(!order) return;

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'deleteOrder',
            rowIndex: rowIndex
          })
        });

        showToast(`Pedido de ${order.nome} exclu√≠do com sucesso!`);
        loadOrders();

      } catch(error){
        console.error('Erro:', error);
        showToast('Erro ao excluir pedido. Tente novamente.', 'error');
      }
    }

    function openValidateModal(rowIndex){
      currentOrder = allOrders.find(o => o.rowIndex === rowIndex);
      if(!currentOrder) return;
      
      document.getElementById('modalClientName').textContent = currentOrder.nome;
      document.getElementById('modalCorrectToken').textContent = currentOrder.token;
      document.getElementById('tokenInput').value = '';
      document.getElementById('validateModal').classList.add('active');
      document.getElementById('tokenInput').focus();
      lucide.createIcons();
    }

    async function confirmDelivery(){
      const inputToken = document.getElementById('tokenInput').value.trim().toUpperCase();
      
      if(!inputToken){
        showToast('Digite o token!', 'error');
        return;
      }

      if(inputToken !== currentOrder.token.toUpperCase()){
        showToast('Token incorreto! Verifique e tente novamente.', 'error');
        return;
      }

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'markDelivered',
            rowIndex: currentOrder.rowIndex
          })
        });

        showToast(`Pedido de ${currentOrder.nome} marcado como entregue!`);
        closeModal();
        loadOrders();

      } catch(error){
        console.error('Erro:', error);
        showToast('Erro ao marcar como entregue. Tente novamente.', 'error');
      }
    }

    function openChangeStatusModal(rowIndex){
      currentOrder = allOrders.find(o => o.rowIndex === rowIndex);
      if(!currentOrder) return;
      
      document.getElementById('modalStatusClientName').textContent = currentOrder.nome;
      document.getElementById('newStatusSelect').value = currentOrder.status || 'pendente';
      document.getElementById('changeStatusModal').classList.add('active');
      lucide.createIcons();
    }

    async function confirmChangeStatus(){
      const newStatus = document.getElementById('newStatusSelect').value;

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'changeStatus',
            rowIndex: currentOrder.rowIndex,
            newStatus: newStatus
          })
        });

        showToast(`Status alterado para: ${newStatus}`);
        closeModal();
        loadOrders();

      } catch(error){
        console.error('Erro:', error);
        showToast('Erro ao alterar status.', 'error');
      }
    }

    function closeModal(){
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
      currentOrder = null;
    }

    // Editar contato
    function openEditModal(order){
      currentOrder = order;
      document.getElementById('editNameInput').value = order.nome || '';
      document.getElementById('editContactInput').value = order.contato || '';
      document.getElementById('editQtyInput').value = order.quantidade || 1;
      document.getElementById('editItemsInput').value = order.itens || '';
      document.getElementById('editPaymentInput').value = order.pagamento || 'aguardando';
      document.getElementById('editModal').classList.add('active');
      lucide.createIcons();
    }

    async function confirmEdit(){
      const nome = document.getElementById('editNameInput').value.trim();
      const contato = document.getElementById('editContactInput').value.trim();
      const quantidade = parseInt(document.getElementById('editQtyInput').value);
      const itens = document.getElementById('editItemsInput').value.trim();
      const pagamento = document.getElementById('editPaymentInput').value;

      if(!nome || !contato || !quantidade){
        return;
        return;
      }

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'editOrder',
            rowIndex: currentOrder.rowIndex,
            nome: nome,
            contato: contato,
            quantidade: quantidade,
            itens: itens,
            pagamento: pagamento
          })
        });

        ;
        closeModal();
        loadOrders();

      } catch(error){
        console.error('Erro:', error);
        ;
      }
    }

    // Manter fun√ß√£o antiga para compatibilidade
    async function confirmEditContact(){
      const newContact = document.getElementById('editContactInput').value.trim();
      if(!newContact){
        showToast('Digite um telefone v√°lido!', 'error');
        return;
      }
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'editContact',
            rowIndex: currentOrder.rowIndex,
            newContact: newContact
          })
        });
        ;
        closeModal();
        loadOrders();
      } catch(error){
        console.error('Erro:', error);
        ;
      }
    }

    // Filtros
    document.getElementById('filterName').addEventListener('input', renderOrders);
    document.getElementById('filterStatus').addEventListener('change', renderOrders);

    // Fechar modal ao clicar fora
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if(e.target === modal){
          closeModal();
        }
      });
    });

    // Carregar ao iniciar
    loadOrders();

    // Registrar Service Worker (PWA) - apenas em HTTPS
    if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => {
            console.log('Service Worker registrado:', registration);
          })
          .catch(error => {
            console.log('Erro ao registrar Service Worker:', error);
          });
      });
    }

    // Prompt de instala√ß√£o PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Mostrar banner de instala√ß√£o (opcional)
      const installBanner = document.createElement('div');
      installBanner.style.cssText = `
        position:fixed;
        bottom:20px;
        left:20px;
        right:20px;
        background:linear-gradient(135deg, #ff6b35, #f77f00);
        color:#fff;
        padding:16px 20px;
        border-radius:12px;
        box-shadow:0 8px 24px rgba(0,0,0,.3);
        z-index:9999;
        display:flex;
        align-items:center;
        justify-content:space-between;
        animation:slideUp .3s ease;
      `;
      
      installBanner.innerHTML = `
        <div style="flex:1;">
          <strong style="display:block;margin-bottom:4px;">üì± Instalar App</strong>
          <span style="font-size:13px;opacity:.9;">Adicione √† tela inicial para acesso r√°pido</span>
        </div>
        <button id="installBtn" style="
          background:#fff;
          color:#ff6b35;
          border:none;
          padding:10px 20px;
          border-radius:8px;
          font-weight:700;
          cursor:pointer;
          margin-left:12px;
        ">Instalar</button>
        <button id="closeInstallBtn" style="
          background:transparent;
          color:#fff;
          border:none;
          padding:10px;
          cursor:pointer;
          font-size:20px;
          margin-left:8px;
        ">√ó</button>
      `;
      
      document.body.appendChild(installBanner);
      
      document.getElementById('installBtn').addEventListener('click', () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('App instalado!');
          }
          deferredPrompt = null;
          installBanner.remove();
        });
      });
      
      document.getElementById('closeInstallBtn').addEventListener('click', () => {
        installBanner.remove();
      });
    });
  </script>

  <!-- BOT√ÉO FLUTUANTE VALIDADOR -->
  <!-- MODAL EDITAR PEDIDO COMPLETO -->
  <div class="modal" id="editModal">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-content" style="max-width:500px;">
      <h3 style="margin:0 0 20px 0;font-size:20px;display:flex;align-items:center;gap:8px;">
        <i data-lucide="edit-3"></i>
        Editar Pedido
      </h3>
      
      <div style="margin-bottom:14px;">
        <label style="display:block;font-size:13px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;">Nome do Cliente</label>
        <input type="text" id="editNameInput" placeholder="Nome completo" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(255,107,53,.3);background:rgba(0,0,0,.2);color:var(--text);font-size:15px;font-family:'Poppins',sans-serif;">
      </div>

      <div style="margin-bottom:14px;">
        <label style="display:block;font-size:13px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;">Telefone</label>
        <input type="tel" id="editContactInput" placeholder="(31) 99999-9999" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(255,107,53,.3);background:rgba(0,0,0,.2);color:var(--text);font-size:15px;font-family:'Poppins',sans-serif;">
      </div>

      <div style="margin-bottom:14px;">
        <label style="display:block;font-size:13px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;">Quantidade de Marmitas</label>
        <input type="number" id="editQtyInput" min="1" placeholder="1" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(255,107,53,.3);background:rgba(0,0,0,.2);color:var(--text);font-size:15px;font-family:'Poppins',sans-serif;">
        <small style="font-size:11px;color:var(--muted);display:block;margin-top:4px;">üí° Valor recalcula autom√°tico (R$ 20/marmita)</small>
      </div>

      <div style="margin-bottom:14px;">
        <label style="display:block;font-size:13px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;">Itens do Pedido</label>
        <input type="text" id="editItemsInput" placeholder="Galinhada, Vinagrete" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(255,107,53,.3);background:rgba(0,0,0,.2);color:var(--text);font-size:15px;font-family:'Poppins',sans-serif;">
      </div>

      <div style="margin-bottom:20px;">
        <label style="display:block;font-size:13px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;">Status de Pagamento</label>
        <select id="editPaymentInput" style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(255,107,53,.3);background:rgba(0,0,0,.2);color:var(--text);font-size:15px;font-family:'Poppins',sans-serif;cursor:pointer;">
          <option value="pago">‚úÖ Pago</option>
          <option value="aguardando">‚è≥ Aguardando Pagamento</option>
        </select>
      </div>

      <div style="display:flex;gap:10px;">
        <button onclick="closeModal()" style="flex:1;padding:13px;border-radius:8px;border:2px solid rgba(255,107,53,.3);background:transparent;color:var(--text);font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;font-size:14px;">Cancelar</button>
        <button onclick="confirmEdit()" class="modal-btn confirm" style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px;"><i data-lucide="save"></i> Salvar</button>
      </div>
    </div>
  </div>

  <a href="validador.html" class="fab-validador" title="Validador R√°pido">
    <i data-lucide="scan-line"></i>
  </a>

</body>
</html>
