<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="description" content="Validador de Token - Galinhada da R√¥">
  <meta name="theme-color" content="#ff6b35">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Validador - Cantina da R√¥">
  
  <title>Validador de Token - Cantina da R√¥</title>

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" href="icon-192.png">

  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap');

    :root{
      --bg:#0a0908;
      --panel:#1a1816;
      --text:#f5f3f0;
      --muted:#b8a89a;
      --accent:#ff6b35;
      --accent2:#f77f00;
      --ok:#4ade80;
      --pending:#fbbf24;
      --danger:#ef4444;
    }

    *{ 
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body{
      margin:0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1a1816 0%, #0a0908 100%);
      color:var(--text);
      min-height:100vh;
      padding:0;
      overflow-x:hidden;
    }

    /* NAVBAR COMPACTO */
    .navbar{
      background: rgba(26,24,22,.98);
      backdrop-filter: blur(10px);
      border-bottom:2px solid rgba(255,107,53,.3);
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }

    .navbar-brand{
      font-size:18px;
      font-weight:900;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .back-btn{
      padding:8px 16px;
      border-radius:8px;
      border:2px solid var(--accent);
      background:rgba(255,107,53,.1);
      color:var(--accent);
      font-weight:600;
      cursor:pointer;
      font-family: 'Poppins', sans-serif;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:6px;
      text-decoration:none;
    }

    .back-btn:active{
      transform: scale(0.95);
    }

    /* CONTAINER */
    .container{
      padding:20px;
      max-width:600px;
      margin:0 auto;
    }

    /* HEADER */
    .header{
      text-align:center;
      margin-bottom:30px;
      padding:30px 20px;
      background: linear-gradient(135deg, rgba(255,107,53,.2), rgba(247,127,0,.15));
      border-radius:20px;
      border:2px solid rgba(255,107,53,.4);
    }

    .header h1{
      font-size:32px;
      font-weight:900;
      margin:0 0 8px 0;
      color:var(--accent);
    }

    .header p{
      font-size:15px;
      color:var(--muted);
      margin:0;
    }

    /* INPUT TOKEN */
    .token-input-section{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.3);
      border-radius:20px;
      padding:30px 20px;
      margin-bottom:20px;
    }

    .token-input-label{
      font-size:14px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
      margin:0 0 12px 0;
      text-align:center;
    }

    .token-input{
      width:100%;
      padding:20px;
      border-radius:12px;
      border:3px solid var(--accent);
      background:rgba(0,0,0,.4);
      color:var(--text);
      font-family: 'Courier New', monospace;
      font-size:32px;
      font-weight:900;
      text-align:center;
      letter-spacing:3px;
      text-transform:uppercase;
      outline:none;
      box-shadow: 0 0 0 4px rgba(255,107,53,.1);
      transition: all .3s;
    }

    .token-input:focus{
      border-color:#fbbf24;
      box-shadow: 0 0 0 6px rgba(251,191,36,.2);
      transform: scale(1.02);
    }

    .hint{
      font-size:13px;
      color:var(--muted);
      text-align:center;
      margin:12px 0 0 0;
    }

    /* BOT√ÉO VALIDAR */
    .validate-btn{
      width:100%;
      padding:20px;
      border-radius:12px;
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
      font-weight:900;
      font-size:20px;
      cursor:pointer;
      font-family: 'Poppins', sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      box-shadow: 0 6px 20px rgba(255,107,53,.4);
      transition: all .3s;
      margin-bottom:20px;
    }

    .validate-btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255,107,53,.5);
    }

    .validate-btn:active{
      transform: translateY(0);
    }

    .validate-btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none !important;
    }

    /* RESULTADO */
    .result-card{
      background: rgba(26,24,22,.8);
      border-radius:20px;
      padding:30px 20px;
      margin-bottom:20px;
      display:none;
      animation: slideIn .4s ease;
    }

    .result-card.show{
      display:block;
    }

    @keyframes slideIn{
      from{
        opacity:0;
        transform:translateY(-20px);
      }
      to{
        opacity:1;
        transform:translateY(0);
      }
    }

    .result-card.success{
      border:3px solid var(--ok);
      background: linear-gradient(135deg, rgba(74,222,128,.15), rgba(34,197,94,.1));
    }

    .result-card.error{
      border:3px solid var(--danger);
      background: linear-gradient(135deg, rgba(239,68,68,.15), rgba(220,38,38,.1));
    }

    .result-card.warning{
      border:3px solid var(--pending);
      background: linear-gradient(135deg, rgba(251,191,36,.15), rgba(245,158,11,.1));
    }

    .result-icon{
      width:80px;
      height:80px;
      margin:0 auto 20px auto;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
      font-size:48px;
    }

    .result-card.success .result-icon{
      background:rgba(74,222,128,.2);
      color:var(--ok);
    }

    .result-card.error .result-icon{
      background:rgba(239,68,68,.2);
      color:var(--danger);
    }

    .result-card.warning .result-icon{
      background:rgba(251,191,36,.2);
      color:var(--pending);
    }

    .result-title{
      font-size:24px;
      font-weight:900;
      text-align:center;
      margin:0 0 10px 0;
    }

    .result-card.success .result-title{
      color:var(--ok);
    }

    .result-card.error .result-title{
      color:var(--danger);
    }

    .result-card.warning .result-title{
      color:var(--pending);
    }

    .result-message{
      font-size:15px;
      color:var(--muted);
      text-align:center;
      margin:0 0 20px 0;
      line-height:1.5;
    }

    .result-details{
      background:rgba(0,0,0,.3);
      border-radius:12px;
      padding:20px;
      margin-bottom:20px;
    }

    .detail-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.1);
    }

    .detail-row:last-child{
      border-bottom:none;
    }

    .detail-label{
      font-size:13px;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .detail-value{
      font-size:16px;
      font-weight:700;
      color:var(--text);
      text-align:right;
    }

    .status-badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .status-badge.pending{
      background:rgba(251,191,36,.2);
      color:#fbbf24;
      border:1px solid #fbbf24;
    }

    .status-badge.delivered{
      background:rgba(74,222,128,.2);
      color:#4ade80;
      border:1px solid #4ade80;
    }

    .status-badge.cancelled{
      background:rgba(239,68,68,.2);
      color:#ef4444;
      border:1px solid #ef4444;
    }

    /* BOT√ïES DE A√á√ÉO */
    .action-buttons{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .action-btn{
      padding:14px;
      border-radius:10px;
      border:none;
      font-weight:700;
      font-size:15px;
      cursor:pointer;
      font-family: 'Poppins', sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: all .3s;
    }

    .action-btn:active{
      transform: scale(0.95);
    }

    .btn-confirm{
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color:#fff;
      box-shadow: 0 4px 12px rgba(74,222,128,.3);
    }

    .btn-new{
      background:rgba(255,107,53,.15);
      color:var(--accent);
      border:2px solid var(--accent);
    }

    /* STATS R√ÅPIDAS */
    .quick-stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-bottom:20px;
    }

    .stat-box{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:12px;
      padding:16px 12px;
      text-align:center;
    }

    .stat-number{
      font-size:28px;
      font-weight:900;
      color:var(--accent);
      margin:0;
    }

    .stat-label{
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
      margin:4px 0 0 0;
    }

    .loading{
      opacity:.6;
      pointer-events:none;
    }

    /* HIST√ìRICO */
    .history{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
      margin-top:20px;
    }

    .history-title{
      font-size:16px;
      font-weight:700;
      color:var(--text);
      margin:0 0 16px 0;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .history-list{
      max-height:300px;
      overflow-y:auto;
    }

    .history-item{
      background:rgba(255,107,53,.05);
      border-radius:10px;
      padding:12px;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-left:4px solid var(--ok);
    }

    .history-info{
      flex:1;
    }

    .history-name{
      font-size:14px;
      font-weight:700;
      color:var(--text);
      margin:0 0 4px 0;
    }

    .history-time{
      font-size:11px;
      color:var(--muted);
      margin:0;
    }

    .history-token{
      font-family: 'Courier New', monospace;
      font-size:13px;
      font-weight:700;
      color:var(--accent);
    }

    .empty-history{
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
    }

    @media (max-width: 768px){
      .header h1{
        font-size:28px;
      }
      
      .token-input{
        font-size:28px;
        padding:18px;
      }
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="navbar-brand">
      üîç Validador de Token
    </div>
    <a href="index.html" class="back-btn">
      <i data-lucide="arrow-left"></i>
      Voltar
    </a>
  </nav>

  <!-- CONTAINER -->
  <div class="container">
    
    <!-- HEADER -->
    <div class="header">
      <h1>‚ö° Valida√ß√£o R√°pida</h1>
      <p>Digite o token do cliente para validar a entrega</p>
    </div>

    <!-- STATS R√ÅPIDAS -->
    <div class="quick-stats">
      <div class="stat-box">
        <p class="stat-number" id="statTotal">0</p>
        <p class="stat-label">Total Hoje</p>
      </div>
      <div class="stat-box">
        <p class="stat-number" id="statValidated">0</p>
        <p class="stat-label">Validados</p>
      </div>
      <div class="stat-box">
        <p class="stat-number" id="statPending">0</p>
        <p class="stat-label">Pendentes</p>
      </div>
    </div>

    <!-- INPUT TOKEN -->
    <div class="token-input-section">
      <p class="token-input-label">Digite o Token</p>
      <input 
        type="text" 
        class="token-input" 
        id="tokenInput" 
        placeholder="7441L23" 
        maxlength="7"
        autofocus
        autocomplete="off"
      >
      <p class="hint">Pressione Enter ou clique em Validar</p>
    </div>

    <!-- BOT√ÉO VALIDAR -->
    <button class="validate-btn" id="validateBtn">
      <i data-lucide="search"></i>
      Buscar e Validar
    </button>

    <!-- RESULTADO -->
    <div class="result-card" id="resultCard">
      <div class="result-icon" id="resultIcon">‚úì</div>
      <h2 class="result-title" id="resultTitle">Token V√°lido!</h2>
      <p class="result-message" id="resultMessage">Pedido encontrado e pronto para entrega</p>
      
      <div class="result-details" id="resultDetails">
        <div class="detail-row">
          <span class="detail-label">Cliente</span>
          <span class="detail-value" id="detailName">‚Äî</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Contato</span>
          <span class="detail-value" id="detailContact">‚Äî</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Quantidade</span>
          <span class="detail-value" id="detailQty">‚Äî</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Valor</span>
          <span class="detail-value" id="detailValue">‚Äî</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value" id="detailStatus">‚Äî</span>
        </div>
      </div>

      <div class="action-buttons" id="actionButtons">
        <button class="action-btn btn-confirm" id="confirmBtn">
          <i data-lucide="check-circle"></i>
          Confirmar Entrega
        </button>
        <button class="action-btn btn-new" id="newSearchBtn">
          <i data-lucide="rotate-ccw"></i>
          Nova Busca
        </button>
      </div>
    </div>

    <!-- HIST√ìRICO -->
    <div class="history">
      <h3 class="history-title">
        <i data-lucide="clock"></i>
        √öltimas Valida√ß√µes
      </h3>
      <div class="history-list" id="historyList">
        <div class="empty-history">
          <i data-lucide="inbox" style="width:48px;height:48px;opacity:.3;margin-bottom:12px;"></i>
          <p>Nenhuma valida√ß√£o ainda</p>
        </div>
      </div>
    </div>

  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWZqrvpUyfTwwl0cnDL9SmnruhVrRRNhzT0sDwsIaRTDdY-77jcwgLne7mESpSUCfy/exec";

    lucide.createIcons();

    let allOrders = [];
    let currentOrder = null;
    let validationHistory = JSON.parse(localStorage.getItem('validationHistory') || '[]');

    // Carregar pedidos
    async function loadOrders(){
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getOrders`);
        const data = await response.json();
        allOrders = data.orders || [];
        updateStats();
      } catch(error){
        console.error('Erro ao carregar:', error);
      }
    }

    // Atualizar estat√≠sticas
    function updateStats(){
      const today = new Date().toLocaleDateString('pt-BR');
      const todayOrders = allOrders.filter(o => o.data_retirada === '07/03/2026');
      const validated = todayOrders.filter(o => o.status === 'entregue').length;
      const pending = todayOrders.filter(o => o.status === 'pendente').length;

      document.getElementById('statTotal').textContent = todayOrders.length;
      document.getElementById('statValidated').textContent = validated;
      document.getElementById('statPending').textContent = pending;
    }

    // Buscar token
    async function searchToken(){
      const token = document.getElementById('tokenInput').value.trim().toUpperCase();
      
      if(!token){
        showResult('error', '‚ùå', 'Token Vazio', 'Por favor, digite um token v√°lido');
        return;
      }

      // Buscar nos pedidos
      const order = allOrders.find(o => o.token.toUpperCase() === token);

      if(!order){
        showResult('error', '‚ùå', 'Token N√£o Encontrado', `O token <strong>${token}</strong> n√£o existe no sistema`);
        playSound('error');
        return;
      }

      currentOrder = order;

      // Verificar status
      if(order.status === 'entregue'){
        showResult('warning', '‚ö†Ô∏è', 'J√° Foi Entregue!', `Este pedido j√° foi validado anteriormente`);
        fillDetails(order, true);
        playSound('warning');
        return;
      }

      if(order.status === 'cancelado'){
        showResult('error', '‚ùå', 'Pedido Cancelado', 'Este pedido foi cancelado e n√£o pode ser entregue');
        fillDetails(order, false);
        playSound('error');
        return;
      }

      // Token v√°lido e pendente
      showResult('success', '‚úì', 'Token V√°lido!', 'Pedido encontrado e pronto para entrega');
      fillDetails(order, false);
      playSound('success');
    }

    // Mostrar resultado
    function showResult(type, icon, title, message){
      const card = document.getElementById('resultCard');
      card.className = `result-card ${type} show`;
      
      document.getElementById('resultIcon').textContent = icon;
      document.getElementById('resultTitle').textContent = title;
      document.getElementById('resultMessage').innerHTML = message;

      // Scroll suave at√© o resultado
      setTimeout(() => {
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }

    // Preencher detalhes
    function fillDetails(order, alreadyDelivered){
      document.getElementById('detailName').textContent = order.nome;
      document.getElementById('detailContact').textContent = order.contato;
      document.getElementById('detailQty').textContent = `${order.quantidade} marmita${order.quantidade > 1 ? 's' : ''}`;
      document.getElementById('detailValue').textContent = order.valor;
      
      const statusBadge = document.createElement('span');
      statusBadge.className = `status-badge ${order.status === 'entregue' ? 'delivered' : order.status === 'cancelado' ? 'cancelled' : 'pending'}`;
      statusBadge.textContent = order.status === 'entregue' ? 'Entregue' : order.status === 'cancelado' ? 'Cancelado' : 'Pendente';
      document.getElementById('detailStatus').innerHTML = '';
      document.getElementById('detailStatus').appendChild(statusBadge);

      // Mostrar/esconder bot√£o de confirmar
      const confirmBtn = document.getElementById('confirmBtn');
      if(alreadyDelivered || order.status === 'cancelado'){
        confirmBtn.style.display = 'none';
        document.getElementById('actionButtons').style.gridTemplateColumns = '1fr';
      } else {
        confirmBtn.style.display = 'flex';
        document.getElementById('actionButtons').style.gridTemplateColumns = '1fr 1fr';
      }
    }

    // Confirmar entrega
    async function confirmDelivery(){
      if(!currentOrder) return;

      const confirmBtn = document.getElementById('confirmBtn');
      const originalContent = confirmBtn.innerHTML;
      confirmBtn.innerHTML = '<i data-lucide="loader"></i> Confirmando...';
      confirmBtn.classList.add('loading');
      lucide.createIcons();

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'markDelivered',
            rowIndex: currentOrder.rowIndex
          })
        });

        // Adicionar ao hist√≥rico
        addToHistory(currentOrder);

        // Atualizar ordem local
        const orderIndex = allOrders.findIndex(o => o.rowIndex === currentOrder.rowIndex);
        if(orderIndex !== -1){
          allOrders[orderIndex].status = 'entregue';
        }

        // Mostrar sucesso
        showResult('success', 'üéâ', 'Entrega Confirmada!', `Pedido de <strong>${currentOrder.nome}</strong> foi marcado como entregue`);
        fillDetails({...currentOrder, status: 'entregue'}, true);
        
        playSound('success');
        updateStats();
        
        // Limpar input e focar
        setTimeout(() => {
          document.getElementById('tokenInput').value = '';
          document.getElementById('tokenInput').focus();
        }, 2000);

      } catch(error){
        console.error('Erro:', error);
        confirmBtn.innerHTML = originalContent;
        confirmBtn.classList.remove('loading');
        lucide.createIcons();
        alert('‚ùå Erro ao confirmar entrega!');
      }
    }

    // Adicionar ao hist√≥rico
    function addToHistory(order){
      const item = {
        nome: order.nome,
        token: order.token,
        time: new Date().toLocaleTimeString('pt-BR')
      };
      
      validationHistory.unshift(item);
      validationHistory = validationHistory.slice(0, 10); // Manter s√≥ 10
      localStorage.setItem('validationHistory', JSON.stringify(validationHistory));
      
      renderHistory();
    }

    // Renderizar hist√≥rico
    function renderHistory(){
      const list = document.getElementById('historyList');
      
      if(validationHistory.length === 0){
        list.innerHTML = `
          <div class="empty-history">
            <i data-lucide="inbox" style="width:48px;height:48px;opacity:.3;margin-bottom:12px;"></i>
            <p>Nenhuma valida√ß√£o ainda</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      list.innerHTML = validationHistory.map(item => `
        <div class="history-item">
          <div class="history-info">
            <p class="history-name">${item.nome}</p>
            <p class="history-time">${item.time}</p>
          </div>
          <div class="history-token">${item.token}</div>
        </div>
      `).join('');
    }

    // Nova busca
    function newSearch(){
      document.getElementById('tokenInput').value = '';
      document.getElementById('tokenInput').focus();
      document.getElementById('resultCard').classList.remove('show');
      currentOrder = null;
    }

    // Sons (feedback auditivo)
    function playSound(type){
      // Vibrar no celular
      if(navigator.vibrate){
        if(type === 'success'){
          navigator.vibrate(200);
        } else if(type === 'error'){
          navigator.vibrate([100, 50, 100]);
        } else if(type === 'warning'){
          navigator.vibrate([100, 100, 100]);
        }
      }
    }

    // Event listeners
    document.getElementById('validateBtn').addEventListener('click', searchToken);
    document.getElementById('confirmBtn').addEventListener('click', confirmDelivery);
    document.getElementById('newSearchBtn').addEventListener('click', newSearch);

    document.getElementById('tokenInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter'){
        searchToken();
      }
    });

    // Auto-uppercase no input
    document.getElementById('tokenInput').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });

    // Carregar ao iniciar
    loadOrders();
    renderHistory();

    // Atualizar a cada 30 segundos
    setInterval(loadOrders, 30000);
  </script>
</body>
</html>
