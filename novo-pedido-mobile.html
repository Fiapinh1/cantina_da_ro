<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Novo Pedido - Mobile</title>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap');

    :root{
      --bg:#0a0908;
      --panel:#1a1816;
      --text:#f5f3f0;
      --muted:#b8a89a;
      --accent:#ff6b35;
      --accent2:#f77f00;
      --dark:#3d2a23;
      --ok:#4ade80;
      --paper:#e8d5c4;
      --paper2:#d9b99a;
    }

    *{ 
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body{
      margin:0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1a1816 0%, #0a0908 100%);
      color:var(--text);
      min-height:100vh;
      padding-bottom:80px;
    }

    /* NAVBAR MOBILE */
    .navbar{
      background: rgba(26,24,22,.98);
      backdrop-filter: blur(10px);
      border-bottom:2px solid rgba(255,107,53,.3);
      padding:12px 16px;
      position:sticky;
      top:0;
      z-index:100;
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }

    .navbar-brand{
      text-align:center;
      font-size:22px;
      font-weight:900;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom:12px;
    }

    .navbar-menu{
      display:flex;
      gap:8px;
      justify-content:center;
    }

    .nav-btn{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:2px solid transparent;
      background:rgba(255,107,53,.1);
      color:var(--muted);
      font-weight:600;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      transition: all .3s;
      font-family: 'Poppins', sans-serif;
      font-size:11px;
      max-width:110px;
    }

    .nav-btn svg{
      width:20px;
      height:20px;
    }

    .nav-btn:active{
      transform: scale(0.95);
    }

    .nav-btn.active{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
    }

    /* CONTAINER */
    .container{
      padding:16px;
      max-width:600px;
      margin:0 auto;
    }

    /* HEADER */
    .header{
      text-align:center;
      margin-bottom:20px;
      padding:20px 16px;
      background: linear-gradient(135deg, rgba(255,107,53,.15), rgba(247,127,0,.1));
      border-radius:16px;
      border:2px solid rgba(255,107,53,.3);
    }

    .header h1{
      font-size:26px;
      font-weight:900;
      margin:0 0 6px 0;
      color:var(--accent);
      text-transform:uppercase;
    }

    .header p{
      font-size:13px;
      color:var(--muted);
      margin:0;
    }

    /* FORM */
    .form-section{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
      margin-bottom:16px;
    }

    .form-group{
      margin-bottom:20px;
    }

    .form-group:last-child{
      margin-bottom:0;
    }

    label{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
      font-weight:700;
      color:var(--text);
      margin:0 0 10px 0;
    }

    label svg{
      width:18px;
      height:18px;
      color:var(--accent);
    }

    input, select{
      width:100%;
      padding:16px;
      border-radius:12px;
      border:2px solid rgba(255,107,53,.3);
      background:rgba(0,0,0,.4);
      color:var(--text);
      font-family: 'Poppins', sans-serif;
      font-size:16px;
      font-weight:500;
      outline:none;
      transition: all .3s;
    }

    input:focus, select:focus{
      border-color:var(--accent);
      background:rgba(0,0,0,.6);
      box-shadow: 0 0 0 4px rgba(255,107,53,.1);
    }

    input[readonly]{
      background:rgba(0,0,0,.2);
      color:var(--muted);
    }

    input[type="number"]{
      font-size:20px;
      font-weight:700;
      text-align:center;
    }

    input[type="tel"]{
      font-size:18px;
      letter-spacing:1px;
    }

    .row-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    /* ITEMS */
    .items-section{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
      margin-bottom:16px;
    }

    .items-title{
      font-size:15px;
      font-weight:700;
      color:var(--text);
      text-transform:uppercase;
      letter-spacing:.5px;
      margin:0 0 14px 0;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .check-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px;
      background:rgba(255,107,53,.08);
      border-radius:12px;
      margin-bottom:10px;
      cursor:pointer;
      transition: all .2s;
      border:2px solid transparent;
    }

    .check-item:active{
      transform: scale(0.98);
    }

    .check-item.checked{
      background:rgba(255,107,53,.15);
      border-color:var(--accent);
    }

    .check-item input[type="checkbox"]{
      width:24px;
      height:24px;
      cursor:pointer;
      accent-color:var(--accent);
    }

    .check-item label{
      margin:0;
      flex:1;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
    }

    .check-item input:disabled{
      opacity:.5;
    }

    /* TOKEN */
    .token-section{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
      margin-bottom:16px;
      text-align:center;
    }

    .token-display{
      padding:20px;
      background:rgba(255,107,53,.1);
      border-radius:12px;
      border:2px dashed var(--accent);
      margin:12px 0;
    }

    .token-label{
      font-size:12px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
      margin:0 0 8px 0;
    }

    .token-value{
      font-size:32px;
      font-weight:900;
      color:var(--accent);
      font-family: 'Courier New', monospace;
      letter-spacing:3px;
      margin:0;
    }

    .token-value.empty{
      font-size:16px;
      color:var(--muted);
    }

    /* BUTTONS */
    .btn{
      width:100%;
      padding:18px;
      border-radius:12px;
      border:none;
      font-weight:700;
      cursor:pointer;
      font-family: 'Poppins', sans-serif;
      font-size:16px;
      transition: all .3s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-bottom:12px;
    }

    .btn:active{
      transform: scale(0.98);
    }

    .btn-primary{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
      box-shadow: 0 4px 16px rgba(255,107,53,.3);
    }

    .btn-secondary{
      background:rgba(255,107,53,.15);
      color:var(--accent);
      border:2px solid var(--accent);
    }

    .btn-success{
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color:#fff;
      box-shadow: 0 4px 16px rgba(74,222,128,.3);
    }

    .btn-group{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:16px;
    }

    .success-msg{
      display:none;
      padding:16px;
      background:rgba(74,222,128,.15);
      border:2px solid #4ade80;
      border-radius:12px;
      color:#4ade80;
      font-size:14px;
      font-weight:600;
      text-align:center;
      margin-bottom:12px;
      animation: slideIn .4s ease;
    }

    .success-msg.show{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    @keyframes slideIn{
      from{
        opacity:0;
        transform:translateY(-10px);
      }
      to{
        opacity:1;
        transform:translateY(0);
      }
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
      padding:14px;
      background:rgba(255,107,53,.05);
      border-radius:10px;
      border:1px solid rgba(255,107,53,.2);
      margin-top:12px;
    }

    /* PREVIEW COMPACTO */
    .preview-compact{
      background: linear-gradient(135deg, var(--paper), var(--paper2));
      border-radius:16px;
      padding:20px;
      margin-bottom:16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }

    .preview-header{
      text-align:center;
      margin-bottom:16px;
      padding-bottom:16px;
      border-bottom:2px dashed rgba(61,42,35,.3);
    }

    .preview-title{
      font-size:20px;
      font-weight:900;
      color:var(--dark);
      text-transform:uppercase;
      margin:0 0 8px 0;
    }

    .preview-brand{
      display:inline-block;
      font-size:28px;
      font-weight:900;
      padding:6px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
      border-radius:10px;
    }

    .preview-info{
      display:grid;
      gap:10px;
      margin-bottom:14px;
    }

    .preview-row{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      background:rgba(255,255,255,.6);
      border-radius:8px;
    }

    .preview-row svg{
      width:18px;
      height:18px;
      color:var(--accent);
      flex-shrink:0;
    }

    .preview-row strong{
      font-size:11px;
      color:var(--muted);
      min-width:70px;
    }

    .preview-row span{
      font-size:13px;
      font-weight:700;
      color:var(--dark);
      flex:1;
    }

    .loading{
      opacity:.6;
      pointer-events:none;
    }

    /* BOTTOM NAV FIXO */
    .bottom-nav{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:rgba(26,24,22,.98);
      backdrop-filter:blur(10px);
      border-top:2px solid rgba(255,107,53,.3);
      padding:12px 16px;
      box-shadow: 0 -4px 20px rgba(0,0,0,.4);
      z-index:99;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="navbar-brand">
      üçó Galinhada da R√¥
    </div>
    <div class="navbar-menu">
      <button class="nav-btn" onclick="window.location.href='dashboard-mobile.html'">
        <i data-lucide="layout-dashboard"></i>
        <span>Dashboard</span>
      </button>
      <button class="nav-btn active">
        <i data-lucide="plus-circle"></i>
        <span>Novo Pedido</span>
      </button>
      <button class="nav-btn" onclick="window.location.href='relatorios-mobile.html'">
        <i data-lucide="bar-chart-3"></i>
        <span>Relat√≥rios</span>
      </button>
    </div>
  </nav>

  <!-- CONTAINER -->
  <div class="container">
    
    <!-- HEADER -->
    <div class="header">
      <h1>üçó Vale Galinhada</h1>
      <p>Preencha os dados do pedido</p>
    </div>

    <!-- FORM -->
    <div class="form-section">
      <div class="form-group">
        <label>
          <i data-lucide="user"></i>
          Nome do cliente
        </label>
        <input type="text" id="inName" placeholder="Ex: Beatriz Lins" autocomplete="name" />
      </div>

      <div class="form-group">
        <label>
          <i data-lucide="phone"></i>
          Telefone
        </label>
        <input type="tel" id="inContact" placeholder="(00) 00000-0000" maxlength="15" inputmode="numeric" autocomplete="tel" />
      </div>

      <div class="row-2">
        <div class="form-group">
          <label>
            <i data-lucide="shopping-bag"></i>
            Quantidade
          </label>
          <input type="number" id="inQty" min="1" value="1" inputmode="numeric" />
        </div>

        <div class="form-group">
          <label>
            <i data-lucide="dollar-sign"></i>
            Valor
          </label>
          <input type="text" id="inTotal" value="R$ 20,00" readonly />
        </div>
      </div>
    </div>

    <!-- ITEMS -->
    <div class="items-section">
      <div class="items-title">
        üçΩÔ∏è Itens da Marmita
      </div>
      
      <div class="check-item checked">
        <input type="checkbox" class="item-checkbox" data-label="Galinhada" checked disabled id="check1" />
        <label for="check1">üçó Galinhada (obrigat√≥rio)</label>
      </div>

      <div class="check-item checked" onclick="toggleCheck(this, 'check2')">
        <input type="checkbox" class="item-checkbox" data-label="Vinagrete" checked id="check2" />
        <label for="check2">ü•ó Vinagrete</label>
      </div>
    </div>

    <!-- PREVIEW COMPACTO -->
    <div class="preview-compact">
      <div class="preview-header">
        <div class="preview-title">Vale Galinhada</div>
        <div class="preview-brand">DA R√î</div>
      </div>

      <div class="preview-info">
        <div class="preview-row">
          <i data-lucide="user"></i>
          <strong>Cliente:</strong>
          <span id="vName">‚Äî</span>
        </div>

        <div class="preview-row">
          <i data-lucide="phone"></i>
          <strong>Contato:</strong>
          <span id="vContact">‚Äî</span>
        </div>

        <div class="preview-row">
          <i data-lucide="shopping-bag"></i>
          <strong>Quantidade:</strong>
          <span id="vQty">01 marmita - R$ 20,00</span>
        </div>

        <div class="preview-row">
          <i data-lucide="calendar"></i>
          <strong>Retirada:</strong>
          <span>07/03/2026</span>
        </div>
      </div>
    </div>

    <!-- TOKEN -->
    <div class="token-section">
      <h3 style="margin:0 0 12px 0;font-size:16px;font-weight:700;">
        üîë Token de Retirada
      </h3>
      
      <div class="token-display">
        <p class="token-label">C√≥digo</p>
        <p class="token-value empty" id="vToken">Clique para gerar</p>
      </div>

      <button class="btn btn-secondary" id="btnGenerateToken">
        <i data-lucide="key"></i>
        Gerar Token
      </button>
    </div>

    <!-- SUCCESS MESSAGE -->
    <div id="successMsg" class="success-msg">
      <i data-lucide="check-circle"></i>
      Pedido salvo com sucesso!
    </div>

    <!-- ACTIONS -->
    <button class="btn btn-success" id="btnSave">
      <i data-lucide="save"></i>
      Salvar Pedido
    </button>

    <div class="btn-group">
      <button class="btn btn-primary" id="btnPNG">
        <i data-lucide="download"></i>
        Baixar
      </button>
      <button class="btn btn-secondary" id="btnShare">
        <i data-lucide="share-2"></i>
        Compartilhar
      </button>
    </div>

    <div class="hint">
      üí° <b>Dicas:</b> Preencha os dados, gere o token e salve. O vale √© atualizado automaticamente!
    </div>
  </div>

  <!-- VALE OCULTO (para gerar PNG) -->
  <div id="voucherHidden" style="position:fixed;left:-9999px;top:0;">
    <div style="width:600px;background:linear-gradient(135deg,#e8d5c4,#d9b99a);padding:32px;border-radius:24px;">
      <div style="text-align:center;padding:20px;background:rgba(255,107,53,.2);border-radius:20px;border:3px dashed rgba(61,42,35,.4);margin-bottom:20px;">
        <div style="font-size:36px;font-weight:900;color:#3d2a23;text-transform:uppercase;margin-bottom:12px;">Vale Galinhada</div>
        <div style="display:inline-block;font-size:52px;font-weight:900;padding:12px 28px;background:linear-gradient(135deg,#ff6b35,#f77f00);color:#fff;border-radius:16px;">DA R√î</div>
        <div style="position:absolute;top:16px;right:16px;background:#fff;padding:10px 18px;border-radius:12px;border:2px solid #ff6b35;">
          <div style="font-size:11px;font-weight:700;color:#ff6b35;margin:0;">RETIRADA</div>
          <div style="font-size:22px;font-weight:900;color:#3d2a23;margin:0;">07/03</div>
        </div>
      </div>

      <div style="background:#fff;padding:24px;border-radius:20px;margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:2px solid rgba(61,42,35,.1);">
          <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff6b35,#f77f00);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;">üë§</div>
          <div style="flex:1;">
            <div style="font-size:11px;font-weight:700;color:#b8a89a;text-transform:uppercase;margin:0 0 2px 0;">Cliente</div>
            <div style="font-size:16px;font-weight:700;color:#3d2a23;margin:0;" id="vNameHidden">‚Äî</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:2px solid rgba(61,42,35,.1);">
          <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff6b35,#f77f00);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;">üì±</div>
          <div style="flex:1;">
            <div style="font-size:11px;font-weight:700;color:#b8a89a;text-transform:uppercase;margin:0 0 2px 0;">Contato</div>
            <div style="font-size:16px;font-weight:700;color:#3d2a23;margin:0;" id="vContactHidden">‚Äî</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;padding:12px 0;">
          <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff6b35,#f77f00);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;">üõçÔ∏è</div>
          <div style="flex:1;">
            <div style="font-size:11px;font-weight:700;color:#b8a89a;text-transform:uppercase;margin:0 0 2px 0;">Quantidade & Valor</div>
            <div style="font-size:16px;font-weight:700;color:#3d2a23;margin:0;" id="vQtyHidden">01 marmita - R$ 20,00</div>
          </div>
        </div>
      </div>

      <div style="background:rgba(255,107,53,.15);padding:18px;border-radius:20px;border:2px solid rgba(61,42,35,.2);margin-bottom:16px;">
        <div style="font-size:16px;font-weight:900;color:#3d2a23;text-align:center;text-transform:uppercase;margin:0 0 12px 0;">üìã Resumo do Pedido</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;" id="vItemsHidden">
          <span style="background:#fff;color:#3d2a23;padding:10px 20px;border-radius:30px;font-weight:700;font-size:15px;border:2px solid #ff6b35;">Galinhada</span>
          <span style="background:#fff;color:#3d2a23;padding:10px 20px;border-radius:30px;font-weight:700;font-size:15px;border:2px solid #ff6b35;">Vinagrete</span>
        </div>
      </div>

      <div style="background:#fff;padding:16px;border-radius:16px;text-align:center;border:2px dashed #ff6b35;margin-bottom:16px;">
        <div style="font-size:11px;font-weight:700;color:#b8a89a;text-transform:uppercase;margin:0 0 6px 0;">üîë Token de Retirada</div>
        <div style="font-size:28px;font-weight:900;color:#ff6b35;font-family:'Courier New',monospace;letter-spacing:3px;margin:0;" id="vTokenHidden">----</div>
      </div>

      <div style="background:linear-gradient(135deg,#4ade80,#22c55e);padding:16px 20px;border-radius:16px;display:flex;align-items:center;justify-content:center;gap:12px;color:#fff;font-weight:700;font-size:14px;text-align:center;">
        <span style="font-size:24px;">‚úì</span>
        <span>Apresente este vale no dia da retirada</span>
      </div>
    </div>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWZqrvpUyfTwwl0cnDL9SmnruhVrRRNhzT0sDwsIaRTDdY-77jcwgLne7mESpSUCfy/exec";

    lucide.createIcons();

    const $ = (id) => document.getElementById(id);
    let currentToken = "";

    // Toggle checkbox com toque
    function toggleCheck(element, checkId){
      const checkbox = document.getElementById(checkId);
      if(!checkbox.disabled){
        checkbox.checked = !checkbox.checked;
        if(checkbox.checked){
          element.classList.add('checked');
        } else {
          element.classList.remove('checked');
        }
        updateVoucher();
      }
    }

    // Formatar telefone
    function formatPhone(value){
      const digits = (value ?? "").toString().replace(/\D/g, "").slice(0, 11);
      if(!digits) return "";
      if(digits.length <= 2) return `(${digits}`;
      const ddd = digits.slice(0,2);
      const first = digits.slice(2,7);
      const last = digits.slice(7);
      if(!last) return `(${ddd}) ${first}`;
      return `(${ddd}) ${first}-${last}`;
    }

    // Gerar token simples
    function generateToken(){
      const contact = $("inContact").value || "";
      const name = $("inName").value || "";
      
      const digits = contact.replace(/\D/g, '');
      const last4 = digits.slice(-4) || '0000';
      const firstLetter = name.charAt(0).toUpperCase() || 'X';
      const random = Math.floor(Math.random() * 99).toString().padStart(2, '0');
      
      return `${last4}${firstLetter}${random}`;
    }

    function safeText(v){ return (v ?? "").toString().trim(); }

    // Atualizar preview
    function updateVoucher(){
      const name = safeText($("inName").value);
      const qtyRaw = parseInt($("inQty").value || "1", 10);
      const qty = Number.isFinite(qtyRaw) && qtyRaw > 0 ? qtyRaw : 1;
      const contact = formatPhone($("inContact").value);

      $("vName").textContent = name || "‚Äî";
      $("vContact").textContent = contact || "‚Äî";

      const unitPrice = 20;
      const total = qty * unitPrice;
      const currency = new Intl.NumberFormat("pt-BR", { 
        style:"currency", 
        currency:"BRL" 
      }).format(total);

      $("inTotal").value = currency;
      $("vQty").textContent = `${qty.toString().padStart(2,"0")} marmita${qty > 1 ? "s" : ""} - ${currency}`;

      // Atualizar hidden
      $("vNameHidden").textContent = name || "‚Äî";
      $("vContactHidden").textContent = contact || "‚Äî";
      $("vQtyHidden").textContent = $("vQty").textContent;

      // Itens
      const items = Array.from(document.querySelectorAll(".item-checkbox"))
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.label);
      
      $("vItemsHidden").innerHTML = items.map(item => 
        `<span style="background:#fff;color:#3d2a23;padding:10px 20px;border-radius:30px;font-weight:700;font-size:15px;border:2px solid #ff6b35;">${item}</span>`
      ).join('');

      lucide.createIcons();
    }

    // Eventos
    ["inName","inQty"].forEach(id => {
      $(id).addEventListener("input", updateVoucher);
    });

    $("inContact").addEventListener("input", ()=>{
      const formatted = formatPhone($("inContact").value);
      $("inContact").value = formatted;
      updateVoucher();
    });

    document.querySelectorAll(".item-checkbox").forEach(cb=>{
      cb.addEventListener("change", updateVoucher);
    });

    // Gerar Token
    $("btnGenerateToken").addEventListener("click", ()=>{
      const name = safeText($("inName").value);
      const contact = safeText($("inContact").value);

      if(!name || !contact){
        alert("‚ö†Ô∏è Preencha nome e telefone primeiro!");
        return;
      }

      currentToken = generateToken();
      const tokenEl = $("vToken");
      tokenEl.textContent = currentToken;
      tokenEl.classList.remove("empty");
      
      $("vTokenHidden").textContent = currentToken;
      
      tokenEl.style.transform = "scale(1.1)";
      setTimeout(()=>{ tokenEl.style.transform = "scale(1)"; }, 300);
    });

    // Salvar
    $("btnSave").addEventListener("click", async ()=>{
      const name = safeText($("inName").value);
      const contact = safeText($("inContact").value);

      if(!name || !contact){
        alert("‚ö†Ô∏è Preencha Nome e Telefone!");
        return;
      }

      if(!currentToken){
        alert("‚ö†Ô∏è Clique em 'Gerar Token' primeiro!");
        return;
      }

      const qty = parseInt($("inQty").value || "1", 10);
      const unitPrice = 20;
      const total = qty * unitPrice;
      const selectedItems = Array.from(document.querySelectorAll(".item-checkbox"))
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.label)
        .join(", ");

      const data = {
        timestamp: new Date().toLocaleString("pt-BR"),
        nome: name,
        contato: contact,
        quantidade: qty,
        valor: `R$ ${total.toFixed(2).replace(".", ",")}`,
        data_retirada: "07/03/2026",
        itens: selectedItems,
        token: currentToken,
        endereco: "R. Yolanda Motta Leite, 1439"
      };

      const btn = $("btnSave");
      const originalContent = btn.innerHTML;
      btn.innerHTML = '<i data-lucide="loader"></i> Salvando...';
      btn.classList.add("loading");
      lucide.createIcons();

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        $("successMsg").classList.add("show");
        setTimeout(() => {
          $("successMsg").classList.remove("show");
        }, 3000);

      } catch (error) {
        console.error("Erro:", error);
        alert("‚ùå Erro ao salvar!");
      } finally {
        btn.innerHTML = originalContent;
        btn.classList.remove("loading");
        lucide.createIcons();
      }
    });

    // Download PNG
    $("btnPNG").addEventListener("click", async ()=>{
      if(!currentToken){
        alert("‚ö†Ô∏è Gere o token primeiro!");
        return;
      }

      const node = $("voucherHidden").children[0];
      lucide.createIcons();

      const canvas = await html2canvas(node, {
        backgroundColor: null,
        scale: 2.5,
        useCORS: true
      });

      const dataURL = canvas.toDataURL("image/png", 1.0);
      const a = document.createElement("a");
      a.href = dataURL;
      a.download = `vale-galinhada-${currentToken}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // Compartilhar (Web Share API)
    $("btnShare").addEventListener("click", async ()=>{
      if(!currentToken){
        alert("‚ö†Ô∏è Gere o token primeiro!");
        return;
      }

      if(!navigator.share){
        alert("üì± Compartilhamento n√£o suportado neste navegador. Use 'Baixar' e envie manualmente.");
        return;
      }

      const node = $("voucherHidden").children[0];
      const canvas = await html2canvas(node, {
        backgroundColor: null,
        scale: 2.5,
        useCORS: true
      });

      canvas.toBlob(async (blob) => {
        const file = new File([blob], `vale-${currentToken}.png`, { type: 'image/png' });
        
        try {
          await navigator.share({
            files: [file],
            title: 'Vale Galinhada',
            text: `Vale Galinhada - Token: ${currentToken}`
          });
        } catch(err){
          console.log('Compartilhamento cancelado');
        }
      });
    });

    updateVoucher();
  </script>
</body>
</html>
