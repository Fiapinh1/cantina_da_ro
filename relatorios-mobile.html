<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="description" content="Relat√≥rios e estat√≠sticas - Galinhada da R√¥">
  <meta name="theme-color" content="#ff6b35">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Cantina da R√¥">
  <title>Relat√≥rios - Galinhada da R√¥</title>

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" href="icon-192.png">

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap');

    :root{
      --bg:#0a0908;
      --text:#f5f3f0;
      --muted:#b8a89a;
      --accent:#ff6b35;
      --accent2:#f77f00;
      --ok:#4ade80;
      --pending:#fbbf24;
    }

    *{ 
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body{
      margin:0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1a1816 0%, #0a0908 100%);
      color:var(--text);
      min-height:100vh;
      padding-bottom:20px;
    }

    /* NAVBAR */
    .navbar{
      background: rgba(26,24,22,.98);
      backdrop-filter: blur(10px);
      border-bottom:2px solid rgba(255,107,53,.3);
      padding:12px 16px;
      position:sticky;
      top:0;
      z-index:100;
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }

    .navbar-brand{
      text-align:center;
      font-size:22px;
      font-weight:900;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom:12px;
    }

    .navbar-menu{
      display:flex;
      gap:8px;
      justify-content:center;
    }

    .nav-btn{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:2px solid transparent;
      background:rgba(255,107,53,.1);
      color:var(--muted);
      font-weight:600;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      transition: all .3s;
      font-family: 'Poppins', sans-serif;
      font-size:11px;
      max-width:110px;
    }

    .nav-btn svg{
      width:20px;
      height:20px;
    }

    .nav-btn:active{
      transform: scale(0.95);
    }

    .nav-btn.active{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
    }

    .container{
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }

    @media (min-width: 768px){
      .container{
        padding:24px;
      }
    }

    .header{
      text-align:center;
      margin-bottom:20px;
      padding:20px 16px;
      background: linear-gradient(135deg, rgba(255,107,53,.15), rgba(247,127,0,.1));
      border-radius:16px;
      border:2px solid rgba(255,107,53,.3);
    }

    .header h1{
      font-size:24px;
      font-weight:900;
      margin:0 0 6px 0;
    }

    .header p{
      font-size:13px;
      color:var(--muted);
      margin:0;
    }

    .cards-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      margin-bottom:20px;
    }

    @media (min-width: 768px){
      .cards-grid{
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .card{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
    }

    .card-title{
      font-size:14px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
      margin:0 0 12px 0;
    }

    .metric{
      margin-bottom:14px;
    }

    .metric:last-child{
      margin-bottom:0;
    }

    .metric-label{
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      margin-bottom:4px;
    }

    .metric-value{
      font-size:26px;
      font-weight:900;
      color:var(--accent);
    }

    .chart-container{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
      margin-bottom:20px;
    }

    .chart-title{
      font-size:16px;
      font-weight:700;
      margin:0 0 16px 0;
    }

    canvas{
      max-height:250px;
    }

    .top-items{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
    }

    .item-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px;
      background:rgba(255,107,53,.05);
      border-radius:10px;
      margin-bottom:10px;
    }

    .item-row:last-child{
      margin-bottom:0;
    }

    .item-name{
      font-size:15px;
      font-weight:600;
    }

    .item-count{
      font-size:20px;
      font-weight:900;
      color:var(--accent);
    }

    .loading{
      text-align:center;
      padding:60px 20px;
      color:var(--muted);
    }

    .loading svg{
      width:48px;
      height:48px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin{
      from{ transform:rotate(0deg); }
      to{ transform:rotate(360deg); }
    }

    /* LISTA DE PEDIDOS */
    .order-item{
      background:rgba(255,107,53,.05);
      border-radius:10px;
      padding:14px;
      margin-bottom:10px;
      border-left:4px solid var(--accent);
    }

    .order-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }

    .order-name-row{
      font-size:15px;
      font-weight:700;
      color:var(--text);
    }

    .order-status-badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
    }

    .order-status-badge.pendente{
      background:rgba(251,191,36,.2);
      color:#fbbf24;
    }

    .order-status-badge.entregue{
      background:rgba(74,222,128,.2);
      color:#4ade80;
    }

    .order-status-badge.cancelado{
      background:rgba(239,68,68,.2);
      color:#ef4444;
    }

    .order-details-row{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:6px;
      font-size:13px;
      color:var(--muted);
    }

    .order-detail{
      display:flex;
      align-items:center;
      gap:4px;
    }

    /* IMPRESS√ÉO */
    @media print{
      body{
        background:#fff;
        color:#000;
      }
      
      .navbar, 
      .header button,
      button{
        display:none !important;
      }

      .container{
        max-width:100%;
        padding:20px;
      }

      .header{
        background:#fff;
        border:2px solid #ff6b35;
        page-break-after:avoid;
      }

      .header h1{
        color:#ff6b35;
      }

      .cards-grid,
      .chart-container,
      .top-items{
        page-break-inside:avoid;
        background:#fff;
        border:1px solid #ddd;
        margin-bottom:20px;
      }

      .card{
        background:#f5f5f5;
        border:1px solid #ddd;
      }

      .order-item{
        background:#f9f9f9;
        border-left:3px solid #ff6b35;
        page-break-inside:avoid;
      }

      canvas{
        max-height:300px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      üçó Galinhada da R√¥
    </div>
    <div class="navbar-menu">
      <button class="nav-btn" onclick="window.location.href='index.html'">
        <i data-lucide="layout-dashboard"></i>
        <span>Dashboard</span>
      </button>
      <button class="nav-btn" onclick="window.location.href='novo-pedido-mobile.html'">
        <i data-lucide="plus-circle"></i>
        <span>Novo Pedido</span>
      </button>
      <button class="nav-btn active">
        <i data-lucide="bar-chart-3"></i>
        <span>Relat√≥rios</span>
      </button>
    </div>
  </nav>

  <div class="container">
    
    <div class="header">
      <h1>üìä Relat√≥rios</h1>
      <p>An√°lise das vendas</p>
      
      <div style="display:flex;gap:10px;justify-content:center;margin-top:16px;">
        <button onclick="window.print()" style="
          padding:12px 24px;
          border-radius:10px;
          border:2px solid var(--accent);
          background:rgba(255,107,53,.15);
          color:var(--accent);
          font-weight:700;
          cursor:pointer;
          font-family:'Poppins',sans-serif;
          font-size:14px;
          display:flex;
          align-items:center;
          gap:8px;
        ">
          <i data-lucide="printer"></i>
          Imprimir Relat√≥rio
        </button>
        
        <button onclick="exportToExcel()" style="
          padding:12px 24px;
          border-radius:10px;
          border:none;
          background:linear-gradient(135deg, var(--accent), var(--accent2));
          color:#fff;
          font-weight:700;
          cursor:pointer;
          font-family:'Poppins',sans-serif;
          font-size:14px;
          display:flex;
          align-items:center;
          gap:8px;
        ">
          <i data-lucide="download"></i>
          Exportar Lista
        </button>
      </div>
    </div>

    <div id="loadingState" class="loading">
      <i data-lucide="loader"></i>
      <p>Carregando...</p>
    </div>

    <div id="reportContent" style="display:none;">
      
      <div class="cards-grid">
        <div class="card">
          <div class="card-title">üçó Vendas</div>
          <div class="metric">
            <div class="metric-label">Marmitas Vendidas</div>
            <div class="metric-value" id="totalMarmitas">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">Receita Total</div>
            <div class="metric-value" id="totalReceita" style="font-size:22px;">R$ 0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">üë• Clientes</div>
          <div class="metric">
            <div class="metric-label">Total de Clientes</div>
            <div class="metric-value" id="totalClientes">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">M√©dia por Pedido</div>
            <div class="metric-value" id="mediaPedido" style="font-size:22px;">0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">‚úÖ Entregas</div>
          <div class="metric">
            <div class="metric-label">Taxa de Entrega</div>
            <div class="metric-value" id="taxaEntrega">0%</div>
          </div>
          <div class="metric">
            <div class="metric-label">Pendentes</div>
            <div class="metric-value" id="totalPendentes" style="font-size:22px;">0</div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <h2 class="chart-title">üìä Status dos Pedidos</h2>
        <canvas id="statusChart"></canvas>
      </div>

      <div class="top-items">
        <h2 class="chart-title">üèÜ Itens Mais Pedidos</h2>
        <div id="topItemsList"></div>
      </div>

      <!-- LISTA DETALHADA DE PEDIDOS -->
      <div class="top-items" style="margin-top:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <h2 class="chart-title" style="margin:0;">üìã Lista de Pedidos</h2>
          <select id="filterStatus" onchange="renderOrdersList()" style="
            padding:8px 12px;
            border-radius:8px;
            border:2px solid rgba(255,107,53,.3);
            background:rgba(0,0,0,.3);
            color:var(--text);
            font-family:'Poppins',sans-serif;
            font-size:13px;
            font-weight:600;
          ">
            <option value="">Todos</option>
            <option value="pendente">Pendentes</option>
            <option value="entregue">Entregues</option>
            <option value="cancelado">Cancelados</option>
          </select>
        </div>
        <div id="ordersList"></div>
      </div>

    </div>

  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWZqrvpUyfTwwl0cnDL9SmnruhVrRRNhzT0sDwsIaRTDdY-77jcwgLne7mESpSUCfy/exec";

    lucide.createIcons();

    let allOrders = [];
    let statusChart = null;

    async function loadReports(){
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getOrders`);
        const data = await response.json();
        
        allOrders = data.orders || [];
        
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('reportContent').style.display = 'block';
        
        if(allOrders.length === 0){
          document.getElementById('reportContent').innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--muted);"><h3>Nenhum pedido</h3><p>Crie pedidos para ver relat√≥rios</p></div>';
          return;
        }
        
        generateReports();
        renderOrdersList();

      } catch(error){
        console.error('Erro:', error);
        document.getElementById('loadingState').innerHTML = '<p style="color:#ef4444;">‚ùå Erro ao carregar</p>';
      }
    }

    function generateReports(){
      try {
        // Filtrar apenas pedidos N√ÉO cancelados
        const activeOrders = allOrders.filter(o => o.status !== 'cancelado');
        
        const totalMarmitas = activeOrders.reduce((sum, o) => sum + parseInt(o.quantidade || 0), 0);
        const totalReceita = activeOrders.reduce((sum, o) => {
          const valorStr = (o.valor || 'R$ 0,00').toString();
          const value = parseFloat(valorStr.replace('R$', '').replace('.', '').replace(',', '.').trim());
          return sum + (isNaN(value) ? 0 : value);
        }, 0);
        
        const totalClientes = new Set(activeOrders.map(o => o.nome).filter(Boolean)).size;
        const mediaPedido = activeOrders.length > 0 ? (totalMarmitas / activeOrders.length).toFixed(1) : 0;
        
        const entregues = activeOrders.filter(o => o.status === 'entregue').length;
        const pendentes = activeOrders.filter(o => o.status === 'pendente' || !o.status).length;
        const taxaEntrega = activeOrders.length > 0 ? ((entregues / activeOrders.length) * 100).toFixed(0) : 0;

        document.getElementById('totalMarmitas').textContent = totalMarmitas;
        document.getElementById('totalReceita').textContent = new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(totalReceita);
        document.getElementById('totalClientes').textContent = totalClientes;
        document.getElementById('mediaPedido').textContent = `${mediaPedido} marmitas`;
        document.getElementById('taxaEntrega').textContent = `${taxaEntrega}%`;
        document.getElementById('totalPendentes').textContent = pendentes;

        const ctx = document.getElementById('statusChart').getContext('2d');
        
        if(statusChart){
          statusChart.destroy();
        }
        
        statusChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Entregues', 'Pendentes'],
            datasets: [{
              data: [entregues, pendentes],
              backgroundColor: ['#4ade80', '#fbbf24'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  color: '#f5f3f0',
                  font: {
                    family: 'Poppins',
                    size: 12,
                    weight: '600'
                  },
                  padding: 16
                }
              }
            }
          }
        });

        const itemsCount = {};
        allOrders.forEach(order => {
          if(order.itens){
            const items = order.itens.split(',').map(i => i.trim());
            items.forEach(item => {
              if(item){
                itemsCount[item] = (itemsCount[item] || 0) + 1;
              }
            });
          }
        });

        const sortedItems = Object.entries(itemsCount).sort((a, b) => b[1] - a[1]);
        
        const topItemsList = document.getElementById('topItemsList');
        topItemsList.innerHTML = '';
        
        if(sortedItems.length === 0){
          topItemsList.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Nenhum item</p>';
        } else {
          sortedItems.forEach(([item, count]) => {
            const emoji = item.toLowerCase().includes('galinhada') ? 'üçó' : 'ü•ó';
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
              <div class="item-name">${emoji} ${item}</div>
              <div class="item-count">${count}</div>
            `;
            topItemsList.appendChild(row);
          });
        }

        lucide.createIcons();
        
      } catch(error){
        console.error('Erro:', error);
        alert('Erro ao processar dados');
      }
    }

    // Renderizar lista de pedidos
    function renderOrdersList(){
      const filterStatus = document.getElementById('filterStatus').value;
      const ordersList = document.getElementById('ordersList');
      
      let filtered = filterStatus ? allOrders.filter(o => o.status === filterStatus) : allOrders;
      
      if(filtered.length === 0){
        ordersList.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Nenhum pedido encontrado</p>';
        return;
      }

      ordersList.innerHTML = filtered.map(order => `
        <div class="order-item">
          <div class="order-header-row">
            <div class="order-name-row">${order.nome}</div>
            <div class="order-status-badge ${order.status || 'pendente'}">${
              order.status === 'entregue' ? 'Entregue' : 
              order.status === 'cancelado' ? 'Cancelado' : 'Pendente'
            }</div>
          </div>
          <div class="order-details-row">
            <div class="order-detail">üì± ${order.contato}</div>
            <div class="order-detail">üõçÔ∏è ${order.quantidade} marmita${order.quantidade > 1 ? 's' : ''}</div>
            <div class="order-detail">üí∞ ${order.valor}</div>
            <div class="order-detail">üîë ${order.token}</div>
          </div>
        </div>
      `).join('');
    }

    // Exportar para Excel/CSV
    function exportToExcel(){
      const activeOrders = allOrders.filter(o => o.status !== 'cancelado');
      
      if(activeOrders.length === 0){
        alert('Nenhum pedido para exportar');
        return;
      }

      // Criar CSV
      let csv = 'Nome,Contato,Quantidade,Valor,Token,Status,Data\\n';
      
      activeOrders.forEach(order => {
        csv += `"${order.nome}","${order.contato}",${order.quantidade},"${order.valor}","${order.token}","${order.status || 'pendente'}","${order.timestamp}"\\n`;
      });

      // Download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `pedidos-galinhada-${new Date().toLocaleDateString('pt-BR')}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    loadReports();
  </script>
</body>
</html>
