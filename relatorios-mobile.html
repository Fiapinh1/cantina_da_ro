<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Relat√≥rios - Galinhada da R√¥</title>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap');

    :root{
      --bg:#0a0908;
      --text:#f5f3f0;
      --muted:#b8a89a;
      --accent:#ff6b35;
      --accent2:#f77f00;
      --ok:#4ade80;
      --pending:#fbbf24;
    }

    *{ 
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body{
      margin:0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1a1816 0%, #0a0908 100%);
      color:var(--text);
      min-height:100vh;
      padding-bottom:20px;
    }

    /* NAVBAR */
    .navbar{
      background: rgba(26,24,22,.98);
      backdrop-filter: blur(10px);
      border-bottom:2px solid rgba(255,107,53,.3);
      padding:12px 16px;
      position:sticky;
      top:0;
      z-index:100;
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }

    .navbar-brand{
      text-align:center;
      font-size:22px;
      font-weight:900;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom:12px;
    }

    .navbar-menu{
      display:flex;
      gap:8px;
      justify-content:center;
    }

    .nav-btn{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:2px solid transparent;
      background:rgba(255,107,53,.1);
      color:var(--muted);
      font-weight:600;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      transition: all .3s;
      font-family: 'Poppins', sans-serif;
      font-size:11px;
      max-width:110px;
    }

    .nav-btn svg{
      width:20px;
      height:20px;
    }

    .nav-btn:active{
      transform: scale(0.95);
    }

    .nav-btn.active{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
    }

    .container{
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }

    @media (min-width: 768px){
      .container{
        padding:24px;
      }
    }

    .header{
      text-align:center;
      margin-bottom:20px;
      padding:20px 16px;
      background: linear-gradient(135deg, rgba(255,107,53,.15), rgba(247,127,0,.1));
      border-radius:16px;
      border:2px solid rgba(255,107,53,.3);
    }

    .header h1{
      font-size:24px;
      font-weight:900;
      margin:0 0 6px 0;
    }

    .header p{
      font-size:13px;
      color:var(--muted);
      margin:0;
    }

    .cards-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      margin-bottom:20px;
    }

    @media (min-width: 768px){
      .cards-grid{
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .card{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
    }

    .card-title{
      font-size:14px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
      margin:0 0 12px 0;
    }

    .metric{
      margin-bottom:14px;
    }

    .metric:last-child{
      margin-bottom:0;
    }

    .metric-label{
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      margin-bottom:4px;
    }

    .metric-value{
      font-size:26px;
      font-weight:900;
      color:var(--accent);
    }

    .chart-container{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
      margin-bottom:20px;
    }

    .chart-title{
      font-size:16px;
      font-weight:700;
      margin:0 0 16px 0;
    }

    canvas{
      max-height:250px;
    }

    .top-items{
      background: rgba(26,24,22,.6);
      border:2px solid rgba(255,107,53,.2);
      border-radius:16px;
      padding:20px;
    }

    .item-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px;
      background:rgba(255,107,53,.05);
      border-radius:10px;
      margin-bottom:10px;
    }

    .item-row:last-child{
      margin-bottom:0;
    }

    .item-name{
      font-size:15px;
      font-weight:600;
    }

    .item-count{
      font-size:20px;
      font-weight:900;
      color:var(--accent);
    }

    .loading{
      text-align:center;
      padding:60px 20px;
      color:var(--muted);
    }

    .loading svg{
      width:48px;
      height:48px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin{
      from{ transform:rotate(0deg); }
      to{ transform:rotate(360deg); }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      üçó Galinhada da R√¥
    </div>
    <div class="navbar-menu">
      <button class="nav-btn" onclick="window.location.href='dashboard-mobile.html'">
        <i data-lucide="layout-dashboard"></i>
        <span>Dashboard</span>
      </button>
      <button class="nav-btn" onclick="window.location.href='novo-pedido-mobile.html'">
        <i data-lucide="plus-circle"></i>
        <span>Novo Pedido</span>
      </button>
      <button class="nav-btn active">
        <i data-lucide="bar-chart-3"></i>
        <span>Relat√≥rios</span>
      </button>
    </div>
  </nav>

  <div class="container">
    
    <div class="header">
      <h1>üìä Relat√≥rios</h1>
      <p>An√°lise das vendas</p>
    </div>

    <div id="loadingState" class="loading">
      <i data-lucide="loader"></i>
      <p>Carregando...</p>
    </div>

    <div id="reportContent" style="display:none;">
      
      <div class="cards-grid">
        <div class="card">
          <div class="card-title">üçó Vendas</div>
          <div class="metric">
            <div class="metric-label">Marmitas Vendidas</div>
            <div class="metric-value" id="totalMarmitas">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">Receita Total</div>
            <div class="metric-value" id="totalReceita" style="font-size:22px;">R$ 0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">üë• Clientes</div>
          <div class="metric">
            <div class="metric-label">Total de Clientes</div>
            <div class="metric-value" id="totalClientes">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">M√©dia por Pedido</div>
            <div class="metric-value" id="mediaPedido" style="font-size:22px;">0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">‚úÖ Entregas</div>
          <div class="metric">
            <div class="metric-label">Taxa de Entrega</div>
            <div class="metric-value" id="taxaEntrega">0%</div>
          </div>
          <div class="metric">
            <div class="metric-label">Pendentes</div>
            <div class="metric-value" id="totalPendentes" style="font-size:22px;">0</div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <h2 class="chart-title">üìä Status dos Pedidos</h2>
        <canvas id="statusChart"></canvas>
      </div>

      <div class="top-items">
        <h2 class="chart-title">üèÜ Itens Mais Pedidos</h2>
        <div id="topItemsList"></div>
      </div>

    </div>

  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWZqrvpUyfTwwl0cnDL9SmnruhVrRRNhzT0sDwsIaRTDdY-77jcwgLne7mESpSUCfy/exec";

    lucide.createIcons();

    let allOrders = [];
    let statusChart = null;

    async function loadReports(){
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getOrders`);
        const data = await response.json();
        
        allOrders = data.orders || [];
        
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('reportContent').style.display = 'block';
        
        if(allOrders.length === 0){
          document.getElementById('reportContent').innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--muted);"><h3>Nenhum pedido</h3><p>Crie pedidos para ver relat√≥rios</p></div>';
          return;
        }
        
        generateReports();

      } catch(error){
        console.error('Erro:', error);
        document.getElementById('loadingState').innerHTML = '<p style="color:#ef4444;">‚ùå Erro ao carregar</p>';
      }
    }

    function generateReports(){
      try {
        const totalMarmitas = allOrders.reduce((sum, o) => sum + parseInt(o.quantidade || 0), 0);
        const totalReceita = allOrders.reduce((sum, o) => {
          const valorStr = (o.valor || 'R$ 0,00').toString();
          const value = parseFloat(valorStr.replace('R$', '').replace('.', '').replace(',', '.').trim());
          return sum + (isNaN(value) ? 0 : value);
        }, 0);
        
        const totalClientes = new Set(allOrders.map(o => o.nome).filter(Boolean)).size;
        const mediaPedido = allOrders.length > 0 ? (totalMarmitas / allOrders.length).toFixed(1) : 0;
        
        const entregues = allOrders.filter(o => o.status === 'entregue').length;
        const pendentes = allOrders.filter(o => o.status === 'pendente' || !o.status).length;
        const taxaEntrega = allOrders.length > 0 ? ((entregues / allOrders.length) * 100).toFixed(0) : 0;

        document.getElementById('totalMarmitas').textContent = totalMarmitas;
        document.getElementById('totalReceita').textContent = new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(totalReceita);
        document.getElementById('totalClientes').textContent = totalClientes;
        document.getElementById('mediaPedido').textContent = `${mediaPedido} marmitas`;
        document.getElementById('taxaEntrega').textContent = `${taxaEntrega}%`;
        document.getElementById('totalPendentes').textContent = pendentes;

        const ctx = document.getElementById('statusChart').getContext('2d');
        
        if(statusChart){
          statusChart.destroy();
        }
        
        statusChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Entregues', 'Pendentes'],
            datasets: [{
              data: [entregues, pendentes],
              backgroundColor: ['#4ade80', '#fbbf24'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  color: '#f5f3f0',
                  font: {
                    family: 'Poppins',
                    size: 12,
                    weight: '600'
                  },
                  padding: 16
                }
              }
            }
          }
        });

        const itemsCount = {};
        allOrders.forEach(order => {
          if(order.itens){
            const items = order.itens.split(',').map(i => i.trim());
            items.forEach(item => {
              if(item){
                itemsCount[item] = (itemsCount[item] || 0) + 1;
              }
            });
          }
        });

        const sortedItems = Object.entries(itemsCount).sort((a, b) => b[1] - a[1]);
        
        const topItemsList = document.getElementById('topItemsList');
        topItemsList.innerHTML = '';
        
        if(sortedItems.length === 0){
          topItemsList.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Nenhum item</p>';
        } else {
          sortedItems.forEach(([item, count]) => {
            const emoji = item.toLowerCase().includes('galinhada') ? 'üçó' : 'ü•ó';
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
              <div class="item-name">${emoji} ${item}</div>
              <div class="item-count">${count}</div>
            `;
            topItemsList.appendChild(row);
          });
        }

        lucide.createIcons();
        
      } catch(error){
        console.error('Erro:', error);
        alert('Erro ao processar dados');
      }
    }

    loadReports();
  </script>
</body>
</html>
